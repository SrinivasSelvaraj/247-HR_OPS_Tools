{% extends "base.html" %}

{% block title %}Instant Employee Exit Check{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('index') }}" class="text-orange-500 hover:text-orange-600">Home</a></li>
            <li><span class="text-slate-400">/</span></li>
            <li class="text-slate-600 dark:text-slate-400">Instant Employee Exit check</li>
        </ol>
    </nav>

    <div class="form-section bg-white dark:bg-slate-800 rounded-lg p-6">
        <header class="app-header mb-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div style="display:flex;align-items:center;">
                    <img id="site-logo" src="{{ url_for('static', filename='images/24-7-logo.jpg') }}" alt="Logo" class="logo h-12" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div id="logo-fallback" style="display:none; align-items:center; font-weight:700; color:var(--accent-primary);">24-7 HR OPS</div>
                </div>
                <div>
                    <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">Instant Employee Exit check</h1>
                    <div class="text-sm text-slate-500 dark:text-slate-400">Data available till 25-sept-2025</div>
                </div>
            </div>
        </header>

        <div class="grid lg:grid-cols-3 gap-4 mb-4">
            <div class="lg:col-span-2">
                <div class="mb-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="flex gap-2">
                            <button id="tab-verify" class="px-3 py-2 bg-orange-500 text-white rounded">Verify</button>
                        </div>
                        <div class="text-sm text-slate-400 ml-3 hidden md:block">Quick search and DOB filter</div>
                    </div>
                    <div>
                        <button id="configure-logo-btn" title="Configure" class="px-2 py-2 bg-slate-700 text-white rounded flex items-center gap-2">
                            <span style="font-size:14px;">⚙️</span>
                            <span class="hidden sm:inline">Configure</span>
                        </button>
                    </div>
                </div>

                <div id="panel-verify">
                    <div class="grid lg:grid-cols-3 gap-4 mb-4 items-center">
                        <div class="col-span-2">
                            <div class="search-box flex flex-col md:flex-row gap-2 items-center">
                                <input id="empid-input" type="text" placeholder="Search by Employee ID..." class="flex-1 px-3 py-2 border rounded bg-white dark:bg-slate-700 text-slate-800" />
                                <button id="search-btn" class="px-4 py-2 bg-orange-500 text-white rounded">Search</button>
                                <div class="dob-group ml-2 flex items-center gap-2" style="min-width:220px;">
                                    <input id="dob-input" type="date" class="w-full px-3 py-2 border rounded bg-slate-700 text-white" />
                                    <button id="dob-btn" class="px-4 py-2 bg-slate-600 text-white rounded">Filter by DOB</button>
                                </div>
                            </div>
                        </div>

                        <div class="hidden lg:block">
                            <!-- instructions moved to aside still, but layout tightened -->
                        </div>
                    </div>

                    <div id="results-container" class="mt-2 text-sm text-slate-700 dark:text-slate-300">
                        <p class="message">Enter search criteria to view employee details.</p>
                    </div>
                </div>

                <div id="panel-config" class="hidden">
            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded border mb-4">
                <h3 class="font-semibold mb-2">Upload znew employee data</h3>
                <p class="text-sm text-slate-600 dark:text-slate-300">Upload an Excel (.xlsx/.xls) or CSV file to replace the current dataset. The file will be converted to Parquet for faster processing.</p>
                <div class="mt-3 flex gap-2">
                    <input id="data-file" type="file" accept=".xlsx,.xls,.csv" />
                    <button id="upload-data-btn" class="px-3 py-2 bg-orange-500 text-white rounded">Upload & Convert</button>
                </div>
                <div id="config-status" class="mt-3 text-sm"></div>
            </div>
            <div class="text-sm text-slate-500 dark:text-slate-400">Current data path: <strong>data/uploads/employee_data.parquet</strong></div>
            <div id="env-status" class="mt-2 text-sm"></div>
        </div>

            </div>
            <aside class="lg:col-span-1">
                <div class="instructions-panel">
                    <h3 class="font-semibold">Instructions & Tips</h3>
                    <ul class="list-disc ml-5 mt-2 text-sm">
                        <li>Do not modify the HRMS-exported files before uploading — upload them as downloaded.</li>
                        <li>Preferred upload formats: Excel (.xlsx/.xls) or CSV. Large files may take a few seconds to convert.</li>
                        <li>The Configure action replaces the current dataset. Keep a backup if needed.</li>
                        <li>After uploading, use the Verify tab to search by Employee ID or filter by DOB.</li>
                        <li>Parquet conversion improves performance for lookups; ensure the upload contains required columns like Employee ID, DOJ, DOB.</li>
                        <li>If conversion fails, check server logs and ensure `pyarrow` or `fastparquet` is available in the environment.</li>
                    </ul>
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
/* Local styles to match project look */
.app-header { display:flex; align-items:center; }
.logo { width:56px; height:auto; }

.form-section { background: linear-gradient(180deg, #0b1720 0%, #0f2630 100%); border: 1px solid rgba(255,255,255,0.04); }
.search-box input, .search-box input[type="date"] { background: #0f1720; border: 1px solid rgba(255,255,255,0.06); color: #e6f7f5; }
.search-box button, #upload-data-btn, .px-4.py-2 { background:#0ea5a4; color:#063; }
.px-4.py-2:hover, #upload-data-btn:hover, .search-box button:hover { filter:brightness(0.95); }
.detail-item { background: #ffffff; border: 1px solid rgba(14,165,164,0.06); padding:0.75rem; border-radius:6px; }
.employee-placard { background: linear-gradient(90deg, rgba(14,165,164,0.06), rgba(255,255,255,0.01)); }
.instructions-box { border-left: 3px solid rgba(14,165,164,0.2); padding-left:12px; background: #f1fcfb; }
.message { color: #0b2540; }

.status-alert { padding: 0.75rem 1rem; border-radius: 6px; background: #fff3f0; border: 1px solid #ffd6cc; color: #7f1d1d; }
.status-ok { padding: 0.75rem 1rem; border-radius: 6px; background: #ecfeff; border: 1px solid #99f6e4; color: #065f46; }

/* Improve contrast and instructions emphasis */
.form-section { color: #e6f7f5; }
.form-section h1 { color: #e6f7f5 !important; }
.form-section .text-sm { color: #cceaed; }
.instructions-panel { background: linear-gradient(180deg,#062a32,#08363f); color: #f8ffff; padding: 1rem; border-radius: 8px; box-shadow: 0 6px 18px rgba(2,6,23,0.6); }
.instructions-panel ul { color: #dff9f6; }

/* DOB group alignment */
.dob-group input { height: 40px; }
.dob-group button { height: 40px; }

.configure-btn { display:inline-flex; align-items:center; gap:8px; }
</style>

<script>
const resultsContainer = document.getElementById('results-container');
const baseUrl = window.location.origin;

function searchEmployee() {
    let empid = document.getElementById('empid-input').value.trim();
    if (!empid) { alert('Please enter an Employee ID.'); return; }
    // ensure Employee ID starts with a leading zero for compatibility
    if (!empid.startsWith('0')) empid = '0' + empid;
    fetchData(`/exit-verifier/verify`, { method: 'POST', body: new URLSearchParams({ employee_id: empid }) }, displayFullResults);
}

function filterByDob() {
    const dob = document.getElementById('dob-input').value;
    if (!dob) { alert('Please select a Date of Birth.'); return; }
    // backend does not expose the DOB summary for this blueprint in provided code, but we attempt GET for compatibility
    fetchData(`/exit-verifier/filter_by_dob_summary?dob=${encodeURIComponent(dob)}`, null, displayDobSummary);
}

function getEmployeeDetails(employeeId) {
    document.getElementById('empid-input').value = employeeId;
    searchEmployee();
}

function fetchData(url, options, displayFunction) {
    resultsContainer.innerHTML = `<p class="message">Loading...</p>`;
    const fetchOpts = options || { method: 'GET' };
    // If a relative path provided, prefix with current origin so requests use same host/port
    const target = (url && (url.startsWith('http://') || url.startsWith('https://'))) ? url : (baseUrl + url);
    fetch(target, fetchOpts)
        .then(resp => resp.json())
        .then(data => displayFunction(data))
        .catch(err => {
            console.error('Fetch error', err);
            resultsContainer.innerHTML = `<p class="message text-red-400">Error: Could not connect to the server.</p>`;
        });
}

// Attach buttons
document.getElementById('search-btn').addEventListener('click', searchEmployee);
document.getElementById('dob-btn').addEventListener('click', filterByDob);
// Tab handling: Verify and Configure only
document.getElementById('tab-verify').addEventListener('click', () => {
    document.getElementById('panel-verify').classList.remove('hidden');
    document.getElementById('panel-config').classList.add('hidden');
});
// removed left Configure tab — use the right Configure button

// configure logo button opens Configure tab
document.getElementById('configure-logo-btn').addEventListener('click', () => {
    document.getElementById('panel-verify').classList.add('hidden');
    document.getElementById('panel-config').classList.remove('hidden');
});

// Configure upload handler
document.getElementById('upload-data-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('data-file');
    const status = document.getElementById('config-status');
    if (!fileInput.files || !fileInput.files.length) {
        alert('Please select a file to upload.');
        return;
    }
    const f = fileInput.files[0];
    const form = new FormData();
    form.append('file', f);
    status.innerText = 'Uploading and converting...';
    try {
        const resp = await fetch('/exit-verifier/configure', { method: 'POST', body: form });
        const j = await resp.json();
        if (resp.ok && j.success) {
            status.innerText = 'Upload and conversion successful.';
        } else {
            status.innerText = 'Error: ' + (j.error || j.message || 'Conversion failed');
        }
    } catch (err) {
        status.innerText = 'Request failed: ' + err.message;
    }
});

// (header configure button removed) right-side behavior no longer required

function displayFullResults(data) {
    resultsContainer.innerHTML = '';
    if (!data) { resultsContainer.innerHTML = `<p class="message">No response</p>`; return; }
    if (data.error || data.message) {
        resultsContainer.innerHTML = `<p class="message">${data.error || data.message}</p>`; return;
    }

    // expect either {success:true, data: {...}} or an array of records
    let employee = null;
    if (data.success && data.data) {
        employee = data.data;
    } else if (Array.isArray(data) && data.length > 0) {
        employee = data[0];
    } else if (typeof data === 'object' && Object.keys(data).length) {
        employee = data;
    }

    if (!employee) { resultsContainer.innerHTML = `<p class="message">Employee not found.</p>`; return; }

    // normalize keys to be safe
    const get = (k) => employee[k] !== undefined ? employee[k] : 'Not Available';

    // Rehire logic
    const isRehirable = /yes|eligible|true/i.test(get('Rehire'));
    const rehireDisplay = isRehirable ? `<span class="text-green">${get('Rehire')} &#10004;</span>` : `<span class="text-red">${get('Rehire')}</span>`;
    let rehireWarning = '';
    if (!isRehirable || get('Rehire') === 'Not Available') {
        rehireWarning = `<div class="warning-box">Contact HR-ER for clarification on rehire status.</div>`;
    }

    // FFS logic
    const ffsVal = parseFloat(String(get('FFS')).replace(/[^0-9.-]/g,''));
    let ffsDisplay = get('FFS');
    let ffsWarning = '';
    if (!isNaN(ffsVal)) {
        ffsDisplay = `<span class="${ffsVal < 0 ? 'text-red' : 'text-green'}">${ffsVal}</span>`;
    }
    if (ffsVal < 0 || get('FFS') === 'Not Available') {
        ffsWarning = `<div class="warning-box">Contact HR Payroll for clarification on FFS.</div>`;
    }

    resultsContainer.innerHTML = `
        <div class="p-4 bg-slate-800 rounded-lg border border-slate-700">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-xl text-orange-400">${get('Employee Name')}</h2>
                    <div class="text-sm text-slate-400">${get('Designation') || ''} — ${get('Department') || ''}</div>
                </div>
                <div class="text-sm bg-orange-600 text-white px-3 py-1 rounded">EMP ID: ${get('Employee ID')}</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="detail-item"><strong>Date of Joining (DOJ):</strong> ${get('DOJ')}</div>
                <div class="detail-item"><strong>Last Working Date:</strong> ${get('Last Working Date')}</div>
                <div class="detail-item"><strong>Date of Birth (DOB):</strong> ${get('DOB')}</div>

                <div class="detail-item"><strong>FFS:</strong> ${ffsDisplay}</div>
                <div class="detail-item"><strong>Rehire Status:</strong> ${rehireDisplay}</div>
                <div class="detail-item"><strong>Exit Status:</strong> ${get('exit_status') || get('Exit Type') || 'Not Available'}</div>

                <div class="detail-item"><strong>Location:</strong> ${get('Location')}</div>
                <div class="detail-item"><strong>Level:</strong> ${get('Level')}</div>
                <div class="detail-item"><strong>Grade:</strong> ${get('Grade')}</div>
            </div>

            ${ffsWarning}
            ${rehireWarning}
        </div>
    `;
}

function displayDobSummary(data) {
    resultsContainer.innerHTML = '';
    if (!data || data.error || data.message) {
        resultsContainer.innerHTML = `<p class="message">${data ? (data.error || data.message) : 'No results'}</p>`; return;
    }
    if (!Array.isArray(data) || data.length === 0) { resultsContainer.innerHTML = `<p class="message">No employees found with this DOB.</p>`; return; }

    let html = '<div class="grid md:grid-cols-2 gap-4' + '">';
    data.forEach(emp => {
        const isRehirable = /yes|eligible|true/i.test(emp.Rehire);
        const ffsVal = parseFloat(String(emp.FFS).replace(/[^0-9.-]/g,''));
        const ffsDisplay = !isNaN(ffsVal) ? `<span class="${ffsVal < 0 ? 'text-red' : 'text-green'}">${ffsVal}</span>` : emp.FFS;
        html += `
            <div class="employee-placard p-3 border rounded cursor-pointer" onclick="getEmployeeDetails('${emp['Employee ID']}')">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="name font-semibold">${emp['Employee Name']}</div>
                        <div class="empid text-sm text-slate-400">ID: ${emp['Employee ID']}</div>
                    </div>
                    <div class="text-right">
                        <div class="placard-rehire">${isRehirable ? '✔️' : '✖️'}</div>
                        <div class="placard-ffs font-bold">${ffsDisplay}</div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    resultsContainer.innerHTML = html;
}

// Load environment status for optional dependencies
async function loadEnvStatus() {
    const el = document.getElementById('env-status');
    if (!el) return;
    el.innerText = 'Checking environment...';
    try {
        const resp = await fetch('/exit-verifier/env_status');
        const j = await resp.json();
        if (j && j.success && j.status) {
            const s = j.status;
            const parts = [];
            parts.push(`Parquet engine: ${s.parquet_enabled ? 'Available' : 'Not available'}`);
            parts.push(`pyarrow: ${s.pyarrow ? 'yes' : 'no'}`);
            parts.push(`fastparquet: ${s.fastparquet ? 'yes' : 'no'}`);
            parts.push(`openpyxl (Excel): ${s.openpyxl ? 'yes' : 'no'}`);
            el.innerHTML = parts.join(' | ');
            el.className = s.parquet_enabled ? 'status-ok' : 'status-alert';
        } else if (j && j.error) {
            el.innerText = 'Env check failed: ' + j.error;
            el.className = 'status-alert';
        } else {
            el.innerText = 'Env check unavailable';
        }
    } catch (err) {
        el.innerText = 'Env check failed';
        el.className = 'status-alert';
    }
}

// Run on load
document.addEventListener('DOMContentLoaded', loadEnvStatus);
</script>
{% endblock %}