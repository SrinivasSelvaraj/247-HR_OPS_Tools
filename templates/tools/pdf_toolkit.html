{% extends "base.html" %}

{% block title %}Complete PDF Toolkit{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('index') }}" class="text-orange-500 hover:text-orange-600">Home</a></li>
            <li><span class="text-slate-400">/</span></li>
            <li class="text-slate-600 dark:text-slate-400">Complete PDF Toolkit</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-4">
            <i class="fas fa-file-pdf text-red-500 mr-3"></i>
            Complete PDF Toolkit
        </h1>
        <p class="text-lg text-slate-600 dark:text-slate-300">
            A comprehensive offline PDF toolkit for all your PDF needs. Merge, split, compress, watermark, convert, and extract text from PDF files.
        </p>
    </div>

    <!-- Main Content -->
    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Operations Panel -->
        <div class="lg:col-span-1">
            <div class="form-section">
                <h3><i class="fas fa-tools"></i>Select Operation</h3>

                <div class="space-y-3">
                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="merge" class="mr-3 text-orange-500" checked>
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Merge PDFs</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Combine multiple PDFs into one</p>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="split" class="mr-3 text-orange-500">
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Split PDF</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Separate PDF pages into multiple files</p>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="compress" class="mr-3 text-orange-500">
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Compress PDF</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Reduce file size while maintaining quality</p>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="watermark" class="mr-3 text-orange-500">
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Add Watermark</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Add text watermark to PDF pages</p>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="convert" class="mr-3 text-orange-500">
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Convert to Images</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Convert PDF pages to image files</p>
                        </div>
                    </label>

                    <label class="flex items-center p-3 border border-slate-300 dark:border-slate-600 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                        <input type="radio" name="operation" value="extract" class="mr-3 text-orange-500">
                        <div>
                            <span class="font-medium text-slate-700 dark:text-slate-300">Extract Text</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Extract text content from PDF</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Operation Options -->
            <div id="operation-options" class="form-section mt-6">
                <!-- Options will be dynamically loaded based on selected operation -->
                <h3><i class="fas fa-cog"></i>Operation Options</h3>
                <div id="options-content">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Select an operation to see available options</p>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="lg:col-span-2">
            <!-- File Upload -->
            <div class="form-section">
                <h3><i class="fas fa-upload"></i>Upload PDF Files</h3>

                <div class="file-upload-area" id="upload-area">
                    <input type="file" id="pdf-input" multiple accept=".pdf" class="hidden">
                    <div class="text-center">
                        <i class="fas fa-file-pdf text-4xl text-red-500 mb-3"></i>
                        <p class="text-lg font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Drop PDF files here or click to browse
                        </p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Maximum file size: 50MB per PDF<br>
                            Multiple files supported for merging
                        </p>
                    </div>
                </div>

                <!-- Selected Files -->
                <div id="selected-files" class="hidden mt-4 space-y-2"></div>
            </div>

            <!-- Process Button -->
            <button id="process-btn" type="button" disabled
                    class="w-full px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-play mr-2"></i>
                Process PDF Files
            </button>

            <!-- Results Area -->
            <div id="results-area" class="hidden form-section mt-6">
                <h3><i class="fas fa-check-circle text-green-500 mr-2"></i>Processing Results</h3>
                <div id="results-content"></div>
            </div>

            <!-- Text Extraction Results -->
            <div id="text-results" class="hidden form-section mt-6">
                <h3><i class="fas fa-file-alt text-blue-500 mr-2"></i>Extracted Text</h3>
                <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <pre id="extracted-text" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap"></pre>
                </div>
                <button id="copy-text-btn" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-copy mr-2"></i>Copy Text
                </button>
            </div>

            <!-- Instructions -->
            <div class="form-section mt-6">
                <h3><i class="fas fa-question-circle"></i>How to Use</h3>
                <ol class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <li>1. Select the PDF operation you want to perform</li>
                    <li>2. Configure operation options (if applicable)</li>
                    <li>3. Upload one or more PDF files</li>
                    <li>4. Click "Process PDF Files" to start</li>
                    <li>5. Download the processed files when complete</li>
                </ol>
            </div>

            <!-- Feature Highlights -->
            <div class="grid md:grid-cols-2 gap-4 mt-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                        <i class="fas fa-shield-alt mr-2"></i>Secure Processing
                    </h4>
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        All PDF files are processed locally on our servers and automatically deleted after processing.
                    </p>
                </div>

                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">
                        <i class="fas fa-bolt mr-2"></i>Fast Processing
                    </h4>
                    <p class="text-sm text-green-700 dark:text-green-300">
                        Optimized algorithms ensure quick processing even for large PDF files and batch operations.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pdfInput = document.getElementById('pdf-input');
    const uploadArea = document.getElementById('upload-area');
    const selectedFilesContainer = document.getElementById('selected-files');
    const processBtn = document.getElementById('process-btn');
    const operationOptions = document.getElementById('operation-options');
    const optionsContent = document.getElementById('options-content');
    const resultsArea = document.getElementById('results-area');
    const resultsContent = document.getElementById('results-content');
    const textResults = document.getElementById('text-results');
    const extractedText = document.getElementById('extracted-text');

    let selectedFiles = [];

    // Operation options configuration
    const operationConfigs = {
        merge: {
            minFiles: 2,
            maxFiles: 50,
            options: `
                <div class="space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                        <p class="text-sm text-blue-700 dark:text-blue-300">
                            <i class="fas fa-info-circle mr-2"></i>
                            Select 2 or more PDF files to merge them into a single document.
                        </p>
                    </div>
                    <div class="text-sm text-slate-600 dark:text-slate-300">
                        Files will be merged in the order they appear in the upload list.
                    </div>
                </div>
            `
        },
        split: {
            minFiles: 1,
            maxFiles: 1,
            options: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Split Type</label>
                        <select id="split-type" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                            <option value="page">Each page as separate file</option>
                            <option value="range">Pages in ranges</option>
                        </select>
                    </div>
                    <div id="pages-range" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Pages per file</label>
                        <input type="number" id="pages-per-file" value="5" min="2" max="50"
                               class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                    </div>
                </div>
            `
        },
        compress: {
            minFiles: 1,
            maxFiles: 1,
            options: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Compression Quality</label>
                        <input type="range" id="compression-quality" min="0.1" max="1" step="0.1" value="0.8"
                               class="w-full">
                        <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400">
                            <span>Low Quality (Smaller)</span>
                            <span id="quality-value">0.8</span>
                            <span>High Quality (Larger)</span>
                        </div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Higher compression may reduce image quality within the PDF.
                        </p>
                    </div>
                </div>
            `
        },
        watermark: {
            minFiles: 1,
            maxFiles: 1,
            options: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Watermark Text</label>
                        <input type="text" id="watermark-text" value="CONFIDENTIAL" placeholder="Enter watermark text"
                               class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Opacity</label>
                        <input type="range" id="watermark-opacity" min="0.1" max="1" step="0.1" value="0.3"
                               class="w-full">
                        <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400">
                            <span>Light</span>
                            <span id="opacity-value">0.3</span>
                            <span>Dark</span>
                        </div>
                    </div>
                </div>
            `
        },
        convert: {
            minFiles: 1,
            maxFiles: 1,
            options: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Output Format</label>
                        <select id="output-format" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                            <option value="PNG">PNG</option>
                            <option value="JPEG">JPEG</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">DPI (Quality)</label>
                        <select id="output-dpi" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100">
                            <option value="96">Standard (96 DPI)</option>
                            <option value="150" selected>High (150 DPI)</option>
                            <option value="300">Print Quality (300 DPI)</option>
                        </select>
                    </div>
                </div>
            `
        },
        extract: {
            minFiles: 1,
            maxFiles: 1,
            options: `
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        <i class="fas fa-info-circle mr-2"></i>
                        Text extraction will pull all readable text from the PDF document.
                        Results will be displayed below for you to copy.
                    </p>
                </div>
            `
        }
    };

    // Initialize with merge operation
    updateOperationOptions('merge');

    // File upload handling
    uploadArea.addEventListener('click', () => pdfInput.click());

    pdfInput.addEventListener('change', (e) => {
        handleFileSelect(Array.from(e.target.files));
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFileSelect(Array.from(e.dataTransfer.files));
    });

    // Operation selection
    document.querySelectorAll('input[name="operation"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            updateOperationOptions(e.target.value);
            updateProcessButton();
        });
    });

    function updateOperationOptions(operation) {
        const config = operationConfigs[operation];
        if (config) {
            optionsContent.innerHTML = config.options;

            // Setup event listeners for dynamic options
            setupOptionListeners(operation);

            // Update upload requirements
            updateUploadArea(operation);
        }
    }

    function setupOptionListeners(operation) {
        // Split type change
        const splitType = document.getElementById('split-type');
        const pagesRange = document.getElementById('pages-range');
        if (splitType && pagesRange) {
            splitType.addEventListener('change', (e) => {
                pagesRange.classList.toggle('hidden', e.target.value === 'page');
            });
        }

        // Compression quality
        const compressionQuality = document.getElementById('compression-quality');
        const qualityValue = document.getElementById('quality-value');
        if (compressionQuality && qualityValue) {
            compressionQuality.addEventListener('input', (e) => {
                qualityValue.textContent = e.target.value;
            });
        }

        // Watermark opacity
        const watermarkOpacity = document.getElementById('watermark-opacity');
        const opacityValue = document.getElementById('opacity-value');
        if (watermarkOpacity && opacityValue) {
            watermarkOpacity.addEventListener('input', (e) => {
                opacityValue.textContent = e.target.value;
            });
        }
    }

    function updateUploadArea(operation) {
        const config = operationConfigs[operation];
        const uploadText = uploadArea.querySelector('p:nth-child(3)');

        if (uploadText) {
            if (operation === 'merge') {
                uploadText.innerHTML = 'Maximum file size: 50MB per PDF<br>Select multiple files for merging';
            } else {
                uploadText.innerHTML = 'Maximum file size: 50MB per PDF<br>Single file operation';
            }
        }
    }

    function handleFileSelect(files) {
        const selectedOperation = document.querySelector('input[name="operation"]:checked').value;
        const config = operationConfigs[selectedOperation];

        selectedFiles = files.filter(file => file.type === 'application/pdf');
        displaySelectedFiles();
        updateProcessButton();
    }

    function displaySelectedFiles() {
        if (selectedFiles.length === 0) {
            selectedFilesContainer.classList.add('hidden');
            return;
        }

        selectedFilesContainer.innerHTML = `
            <h4 class="font-medium text-slate-700 dark:text-slate-300 mb-2">
                Selected Files (${selectedFiles.length})
            </h4>
            <div class="space-y-2">
                ${selectedFiles.map((file, index) => `
                    <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-700 rounded">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <span class="text-sm text-slate-700 dark:text-slate-300">${file.name}</span>
                            <span class="text-xs text-slate-500">(${HROpsToolkit.formatFileSize(file.size)})</span>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        selectedFilesContainer.classList.remove('hidden');
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        displaySelectedFiles();
        updateProcessButton();
    }

    function updateProcessButton() {
        const selectedOperation = document.querySelector('input[name="operation"]:checked').value;
        const config = operationConfigs[selectedOperation];

        const isValid = selectedFiles.length >= config.minFiles &&
                       selectedFiles.length <= config.maxFiles;

        processBtn.disabled = !isValid;

        if (isValid) {
            if (selectedFiles.length === 1) {
                processBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Process PDF File';
            } else {
                processBtn.innerHTML = `<i class="fas fa-play mr-2"></i>Process ${selectedFiles.length} PDF Files`;
            }
        } else {
            processBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Process PDF Files';
        }
    }

    // Process PDF files
    processBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('pdfs', file);
        });

        const selectedOperation = document.querySelector('input[name="operation"]:checked').value;
        formData.append('operation', selectedOperation);

        // Add operation-specific parameters
        if (selectedOperation === 'split') {
            formData.append('split_type', document.getElementById('split-type').value);
            formData.append('pages_per_file', document.getElementById('pages-per-file').value);
        } else if (selectedOperation === 'compress') {
            formData.append('quality', document.getElementById('compression-quality').value);
        } else if (selectedOperation === 'watermark') {
            formData.append('watermark_text', document.getElementById('watermark-text').value);
            formData.append('opacity', document.getElementById('watermark-opacity').value);
        } else if (selectedOperation === 'convert') {
            formData.append('format', document.getElementById('output-format').value);
            formData.append('dpi', document.getElementById('output-dpi').value);
        }

        try {
            processBtn.disabled = true;
            processBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Processing...';

            // Hide previous results
            resultsArea.classList.add('hidden');
            textResults.classList.add('hidden');

            if (selectedOperation === 'extract') {
                // For text extraction, use a different approach
                const response = await fetch('/pdf-toolkit/process', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    extractedText.textContent = result.text;
                    textResults.classList.remove('hidden');
                    HROpsToolkit.showNotification('Text extracted successfully!', 'success');
                    HROpsToolkit.trackEvent('pdf_text_extracted', {
                        text_length: result.text_length
                    });
                } else {
                    throw new Error(result.error || 'Extraction failed');
                }
            } else {
                // For file operations, trigger download
                const response = await fetch('/pdf-toolkit/process', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const filename = getDownloadFilename(selectedOperation);
                    HROpsToolkit.downloadFile(blob, filename);
                    HROpsToolkit.showNotification('PDF operation completed successfully!', 'success');
                    HROpsToolkit.trackEvent('pdf_operation_completed', {
                        operation: selectedOperation,
                        files_count: selectedFiles.length
                    });
                } else {
                    throw new Error('Processing failed');
                }
            }
        } catch (error) {
            HROpsToolkit.showNotification('Processing failed: ' + error.message, 'error');
        } finally {
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Process PDF Files';
        }
    });

    function getDownloadFilename(operation) {
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filenames = {
            merge: `merged_pdfs_${timestamp}.pdf`,
            split: `split_pdfs_${timestamp}.zip`,
            compress: `compressed_pdf_${timestamp}.pdf`,
            watermark: `watermarked_pdf_${timestamp}.pdf`,
            convert: `pdf_images_${timestamp}.zip`
        };
        return filenames[operation] || `pdf_operation_${timestamp}.pdf`;
    }

    // Copy text functionality
    document.getElementById('copy-text-btn').addEventListener('click', () => {
        const text = extractedText.textContent;
        navigator.clipboard.writeText(text).then(() => {
            HROpsToolkit.showNotification('Text copied to clipboard!', 'success');
        }).catch(() => {
            HROpsToolkit.showNotification('Failed to copy text', 'error');
        });
    });

    // Initialize
    updateProcessButton();
});
</script>
{% endblock %}