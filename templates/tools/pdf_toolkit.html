{% extends "base.html" %}

{% block title %}PDF Toolkit{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('index') }}" class="text-orange-500 hover:text-orange-600">Home</a></li>
            <li><span class="text-slate-400">/</span></li>
            <li class="text-slate-600 dark:text-slate-400">PDF Toolkit</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-4">
            <i class="fas fa-file-pdf text-orange-500 mr-3"></i>
            PDF Toolkit
        </h1>
        <p class="text-lg text-slate-600 dark:text-slate-300">
            Crop and optimize, merge, split and convert PDFs — quick and simple.
        </p>
    </div>

    <!-- Main Content (two-column like ID Processor) -->
    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Left: Upload & Options -->
        <div class="space-y-6">
            <div class="form-section">
                <h3><i class="fas fa-upload"></i>Upload Files</h3>
                <div id="dropZone" class="file-upload-area border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center cursor-pointer hover:border-orange-500 transition-colors">
                    <input type="file" id="fileInput" multiple class="hidden" accept=".pdf,.png,.jpg,.jpeg,.gif,.bmp,.webp">
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3"></i>
                        <p class="text-lg font-medium text-slate-700 dark:text-slate-300 mb-2">Drop PDF or image files here or click to browse</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Supported: PDF, PNG, JPG, JPEG, GIF, BMP, WEBP — Max 50MB/file</p>
                    </div>
                </div>

                <!-- Selected Files -->
                <div id="selected-files" class="hidden mt-4 space-y-2"></div>
            </div>

            <!-- Processing Options -->
            <div class="form-section">
                <h3><i class="fas fa-cog"></i>Processing Options</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Operation</label>
                        <select id="operation-select" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                            <option value="merge">Merge PDFs</option>
                            <option value="split">Split PDF</option>
                            <option value="compress">Compress PDF</option>
                            <option value="watermark">Add Watermark</option>
                            <option value="convert">PDF → Images</option>
                            <option value="images_to_pdf">Images → PDF</option>
                            <option value="rotate">Rotate Pages</option>
                            <option value="remove_pages">Remove Pages</option>
                            <option value="pdf_to_word">PDF → Word</option>
                        </select>
                    </div>

                    <div id="dynamic-options" class="hidden"></div>
                </div>

                <button id="process-btn" type="button" disabled class="mt-6 w-full px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 focus:outline-none">
                    <i class="fas fa-play mr-2"></i>Process Files
                </button>
            </div>
        </div>

        <!-- Right: Status & Results -->
        <div class="space-y-6">
            <div id="processing-status" class="hidden form-section">
                <h3><i class="fas fa-info-circle"></i>Processing Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Progress</span>
                        <span id="progress-text" class="text-sm text-slate-600 dark:text-slate-400">0/0 files</span>
                    </div>
                    <div class="progress-bar bg-slate-200 dark:bg-slate-600 rounded h-3 overflow-hidden">
                        <div id="progress-fill" class="h-full bg-orange-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="results-area" class="hidden form-section">
                <div class="flex justify-between items-center mb-4">
                    <h3><i class="fas fa-check-circle"></i>Results</h3>
                    <div class="flex gap-2">
                        <a id="download-all-btn" class="px-4 py-2 bg-green-500 text-white text-sm rounded hover:bg-green-600">Download Result</a>
                        <button id="clear-btn" class="px-4 py-2 bg-red-500 text-white text-sm rounded hover:bg-red-600">Clear</button>
                    </div>
                </div>

                <div id="results-content"></div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-question-circle"></i>How to Use</h3>
                <ol class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <li>1. Select an operation and upload your files</li>
                    <li>2. Configure options (when applicable)</li>
                    <li>3. Click "Process Files" to start</li>
                    <li>4. Download the processed results</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const selectedFilesContainer = document.getElementById('selected-files');
    const operationSelect = document.getElementById('operation-select');
    const dynamicOptions = document.getElementById('dynamic-options');
    const processBtn = document.getElementById('process-btn');
    const processingStatus = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const resultsArea = document.getElementById('results-area');
    const resultsContent = document.getElementById('results-content');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const clearBtn = document.getElementById('clear-btn');

    let selectedFiles = [];
    let currentOperation = operationSelect.value;

    const operationOptions = {
        split: {
            html: `
                <div class="space-y-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Split Method</label>
                        <select id="split-type" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                            <option value="page">Each Page as Separate File</option>
                            <option value="pages_per_pdf">Pages per File</option>
                            <option value="even_odd">Even/Odd pages</option>
                            <option value="halve">Halve pages</option>
                            <option value="custom">Custom ranges</option>
                        </select>
                    </div>
                    <div id="pages-per-file-container" class="hidden">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Pages per File</label>
                        <input type="number" id="pages-per-file" value="5" min="1" max="100" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                    </div>
                    <div id="custom-ranges-container" class="hidden">
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Custom Ranges</label>
                        <input type="text" id="custom-ranges" placeholder="e.g., 1-3,5,7-9" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Enter page ranges separated by commas (e.g., 1-3,5,7-9)</p>
                    </div>
                </div>
            `
        },
        rotate: {
            html: `
                <div class="space-y-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Rotation Angle</label>
                        <select id="rotate-angle" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                            <option value="90">90 Degrees</option>
                            <option value="180">180 Degrees</option>
                            <option value="270">270 Degrees</option>
                        </select>
                    </div>
                </div>
            `
        },
        compress: {
            html: `
                <div class="space-y-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Compression Quality</label>
                        <input type="range" id="compress-quality" min="10" max="95" step="5" value="75" class="w-full">
                        <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400 mt-1">
                            <span>Smaller</span>
                            <span id="compress-quality-value">75</span>
                            <span>Better</span>
                        </div>
                    </div>
                </div>
            `
        },
        remove_pages: {
            html: `
                <div class="space-y-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Specify Pages</label>
                        <input type="text" id="remove-pages" placeholder="e.g., 1,3,5 or 1-5" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Enter page numbers separated by commas or ranges (e.g., 1-5)</p>
                    </div>
                </div>
            `
        },
        watermark: {
            html: `
                <div class="space-y-4 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Watermark Text</label>
                        <input type="text" id="watermark-text" placeholder="CONFIDENTIAL" value="CONFIDENTIAL" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Opacity (0.1 - 1.0)</label>
                        <input type="range" id="watermark-opacity" min="0.1" max="1" step="0.1" value="0.3" class="w-full">
                        <div class="flex justify-between text-xs text-slate-500 dark:text-slate-400">
                            <span>Transparent</span>
                            <span id="opacity-value">0.3</span>
                            <span>Opaque</span>
                        </div>
                    </div>
                </div>
            `
        }
    };

    function renderDynamicOptions(op) {
        dynamicOptions.innerHTML = '';
        if (operationOptions[op]) {
            dynamicOptions.innerHTML = operationOptions[op].html;
            dynamicOptions.classList.remove('hidden');

            if (op === 'split') {
                const splitType = document.getElementById('split-type');
                const pagesContainer = document.getElementById('pages-per-file-container');
                const customContainer = document.getElementById('custom-ranges-container');
                const handleSplitChange = () => {
                    if (splitType.value === 'pages_per_pdf' || splitType.value === 'range') {
                        pagesContainer.classList.remove('hidden');
                    } else {
                        pagesContainer.classList.add('hidden');
                    }
                    if (splitType.value === 'custom') {
                        customContainer.classList.remove('hidden');
                    } else {
                        customContainer.classList.add('hidden');
                    }
                };
                splitType.addEventListener('change', handleSplitChange);
                // initialize visibility
                handleSplitChange();
            }
            if (op === 'watermark') {
                const opacitySlider = document.getElementById('watermark-opacity');
                const opacityValue = document.getElementById('opacity-value');
                opacitySlider.addEventListener('input', () => { opacityValue.textContent = opacitySlider.value; });
            }
            if (op === 'compress') {
                const qualitySlider = document.getElementById('compress-quality');
                const qualityValue = document.getElementById('compress-quality-value');
                if (qualitySlider) qualitySlider.addEventListener('input', () => { qualityValue.textContent = qualitySlider.value; });
            }
        } else {
            dynamicOptions.classList.add('hidden');
        }
    }

    renderDynamicOptions(currentOperation);
    operationSelect.addEventListener('change', (e) => { currentOperation = e.target.value; if (currentOperation === 'images_to_pdf') fileInput.accept = '.png,.jpg,.jpeg,.gif,.bmp,.webp'; else fileInput.accept = '.pdf'; renderDynamicOptions(currentOperation); });

    // File interactions
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/10'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/10'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/10'); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) { selectedFiles = Array.from(files); updateFilesList(); }
    function updateFilesList() {
        if (!selectedFiles || selectedFiles.length === 0) { selectedFilesContainer.classList.add('hidden'); processBtn.disabled = true; return; }
        selectedFilesContainer.classList.remove('hidden'); processBtn.disabled = false;
        selectedFilesContainer.innerHTML = selectedFiles.map((file, idx) => `
            <div class="flex items-center justify-between p-2 bg-slate-100 dark:bg-slate-600 rounded mb-2">
                <span class="text-sm text-slate-700 dark:text-slate-200"><i class="fas fa-file mr-2"></i>${file.name}</span>
                <button type="button" class="text-red-500 hover:text-red-700 remove-file" data-index="${idx}"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
        document.querySelectorAll('.remove-file').forEach(btn => { btn.addEventListener('click', (e) => { const idx = parseInt(e.target.closest('button').dataset.index); selectedFiles.splice(idx, 1); updateFilesList(); }); });
    }

    clearBtn.addEventListener('click', () => { selectedFiles = []; updateFilesList(); resultsArea.classList.add('hidden'); resultsContent.innerHTML = ''; });

    // Process
    processBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) { alert('Please select files'); return; }
        const formData = new FormData(); selectedFiles.forEach(f => formData.append('pdfs', f)); formData.append('operation', operationSelect.value);
        const op = operationSelect.value;
        if (op === 'split') {
            const st = document.getElementById('split-type');
            const ppf = document.getElementById('pages-per-file');
            const custom = document.getElementById('custom-ranges');
            if (st) formData.append('split_type', st.value);
            if (ppf && !ppf.classList.contains('hidden')) formData.append('pages_per_file', ppf.value);
            if (custom && !custom.classList.contains('hidden') && custom.value.trim()) formData.append('custom_ranges', custom.value.trim());
        }
        if (op === 'compress') {
            const q = document.getElementById('compress-quality');
            if (q) formData.append('quality', q.value);
        }
        if (op === 'rotate') { const angle = document.getElementById('rotate-angle'); if (angle) formData.append('angle', angle.value); }
        if (op === 'remove_pages') { const pages = document.getElementById('remove-pages'); if (!pages || !pages.value.trim()) { alert('Please specify pages to remove'); return; } formData.append('pages', pages.value); }
        if (op === 'watermark') { const text = document.getElementById('watermark-text'); const opacity = document.getElementById('watermark-opacity'); if (text) formData.append('watermark_text', text.value); if (opacity) formData.append('opacity', opacity.value); }

        try {
            processingStatus.classList.remove('hidden'); progressFill.style.width = '10%'; progressText.textContent = 'Starting...'; processBtn.disabled = true;
            const response = await fetch('/pdf-toolkit/process', { method: 'POST', body: formData });
            if (!response.ok) { const err = await response.json().catch(() => null); throw new Error(err ? (err.error || JSON.stringify(err)) : `HTTP ${response.status}`); }
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const data = await response.json(); if (data.text) { progressFill.style.width = '100%'; progressText.textContent = 'Done'; resultsContent.innerHTML = `<div class="p-4 bg-white dark:bg-slate-700 rounded max-h-56 overflow-y-auto"><pre class="whitespace-pre-wrap">${escapeHtml(data.text)}</pre></div>`; resultsArea.classList.remove('hidden'); }
            } else {
                const blob = await response.blob(); progressFill.style.width = '100%'; progressText.textContent = 'Done';
                let filename = getFilenameFromResponse(response); if (!filename) { if (blob.type.includes('zip')) filename = `${op}_${Date.now()}.zip`; else if (blob.type.includes('word') || blob.type.includes('officedocument')) filename = `${op}_${Date.now()}.docx`; else filename = `${op}_${Date.now()}.pdf`; }
                const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 1000); resultsArea.classList.remove('hidden');
            }
        } catch (err) { alert('Error: ' + err.message); } finally { processBtn.disabled = false; }
    });

    function getFilenameFromResponse(response) { const disposition = response.headers.get('content-disposition'); if (!disposition) return null; const matches = /filename[^;=\\n]*=(['\"]?)([^'\";\\n]*)\1/.exec(disposition); return matches && matches[2] ? matches[2] : null; }
    function escapeHtml(text) { const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return String(text).replace(/[&<>"']/g, m => map[m]); }
});
</script>
{% endblock %}
