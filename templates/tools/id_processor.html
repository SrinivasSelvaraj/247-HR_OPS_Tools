{% extends "base.html" %}

{% block title %}ID Image Processor{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Breadcrumb Navigation -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('index') }}" class="text-orange-500 hover:text-orange-600">Home</a></li>
            <li><span class="text-slate-400">/</span></li>
            <li class="text-slate-600 dark:text-slate-400">ID Image Processor</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-4">
            <i class="fas fa-id-card text-orange-500 mr-3"></i>
            ID Image Processor
        </h1>
        <p class="text-lg text-slate-600 dark:text-slate-300">
            Crop and optimize candidate images for ID cards and HRMS systems. Supports both single and bulk processing with automatic face detection.
        </p>
    </div>

    <!-- Main Content -->
    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Upload Section -->
        <div class="space-y-6">
            <!-- Upload Area -->
            <div class="form-section">
                <h3><i class="fas fa-upload"></i>Upload Images</h3>

                <div class="file-upload-area" id="upload-area">
                    <input type="file" id="image-input" multiple accept="image/*" class="hidden">
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3"></i>
                        <p class="text-lg font-medium text-slate-700 dark:text-slate-300 mb-2">
                            Drop images here or click to browse
                        </p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Supports: PNG, JPG, JPEG, GIF, BMP, TIFF, WebP<br>
                            Maximum file size: 16MB per image
                        </p>
                    </div>
                </div>

                <!-- Selected Files -->
                <div id="selected-files" class="hidden mt-4 space-y-2"></div>
            </div>

            <!-- Processing Options -->
            <div class="form-section">
                <h3><i class="fas fa-cog"></i>Processing Options</h3>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="output-width" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                            Output Width (pixels)
                        </label>
                        <input type="number" id="output-width" value="200" min="100" max="500"
                               class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>

                    <div>
                        <label for="output-height" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                            Output Height (pixels)
                        </label>
                        <input type="number" id="output-height" value="250" min="100" max="500"
                               class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                </div>

                <div class="mt-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="detect-face" checked
                               class="w-4 h-4 text-orange-500 bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 rounded focus:ring-orange-500">
                        <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">
                            Enable face detection for better cropping
                        </span>
                    </label>
                </div>

                <!-- Quick Size Presets -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                        Quick Size Presets
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="size-preset px-3 py-1 text-sm bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded hover:bg-slate-300 dark:hover:bg-slate-600"
                                data-width="150" data-height="200">Small (150x200)</button>
                        <button type="button" class="size-preset px-3 py-1 text-sm bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded hover:bg-slate-300 dark:hover:bg-slate-600"
                                data-width="200" data-height="250">Medium (200x250)</button>
                        <button type="button" class="size-preset px-3 py-1 text-sm bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded hover:bg-slate-300 dark:hover:bg-slate-600"
                                data-width="300" data-height="400">Large (300x400)</button>
                    </div>
                </div>

                <!-- Process Button -->
                <button id="process-btn" type="button" disabled
                        class="mt-6 w-full px-6 py-3 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-magic mr-2"></i>
                    Process Images
                </button>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="space-y-6">
            <!-- Processing Status -->
            <div id="processing-status" class="hidden form-section">
                <h3><i class="fas fa-info-circle"></i>Processing Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Progress</span>
                        <span id="progress-text" class="text-sm text-slate-600 dark:text-slate-400">0/0 images</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Processed Images -->
            <div id="processed-images-container" class="hidden form-section">
                <div class="flex justify-between items-center mb-4">
                    <h3><i class="fas fa-images"></i>Processed Images</h3>
                    <div class="flex gap-2">
                        <button id="download-all-btn" type="button"
                                class="px-4 py-2 bg-green-500 text-white text-sm rounded hover:bg-green-600">
                            <i class="fas fa-download mr-1"></i> Download All
                        </button>
                        <button id="clear-btn" type="button"
                                class="px-4 py-2 bg-red-500 text-white text-sm rounded hover:bg-red-600">
                            <i class="fas fa-trash mr-1"></i> Clear
                        </button>
                    </div>
                </div>

                <div id="processed-images" class="id-preview-container"></div>
            </div>

            <!-- Instructions -->
            <div class="form-section">
                <h3><i class="fas fa-question-circle"></i>How to Use</h3>
                <ol class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <li>1. Select images by clicking the upload area or dragging files</li>
                    <li>2. Choose your preferred output dimensions or use presets</li>
                    <li>3. Enable face detection for automatic cropping (recommended)</li>
                    <li>4. Click "Process Images" to start processing</li>
                    <li>5. Preview results and download individual images or all as ZIP</li>
                </ol>
            </div>

            <!-- Tips -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                    <i class="fas fa-lightbulb mr-2"></i>Pro Tips
                </h4>
                <ul class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                    <li>• Use high-quality images for best results</li>
                    <li>• Face detection works best with front-facing photos</li>
                    <li>• Standard ID card size is 200x250 pixels</li>
                    <li>• Process in batches for better efficiency</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const imageInput = document.getElementById('image-input');
    const uploadArea = document.getElementById('upload-area');
    const selectedFilesContainer = document.getElementById('selected-files');
    const processBtn = document.getElementById('process-btn');
    const processedImagesContainer = document.getElementById('processed-images-container');
    const processedImages = document.getElementById('processed-images');
    const processingStatus = document.getElementById('processing-status');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    let selectedFiles = [];

    // File upload handling
    uploadArea.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', (e) => {
        handleFileSelect(Array.from(e.target.files));
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFileSelect(Array.from(e.dataTransfer.files));
    });

    function handleFileSelect(files) {
        selectedFiles = files.filter(file => file.type.startsWith('image/'));
        displaySelectedFiles();
        updateProcessButton();
    }

    function displaySelectedFiles() {
        if (selectedFiles.length === 0) {
            selectedFilesContainer.classList.add('hidden');
            return;
        }

        selectedFilesContainer.innerHTML = `
            <h4 class="font-medium text-slate-700 dark:text-slate-300 mb-2">
                Selected Files (${selectedFiles.length})
            </h4>
            <div class="space-y-2">
                ${selectedFiles.map((file, index) => `
                    <div class="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-700 rounded">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-image text-slate-400"></i>
                            <span class="text-sm text-slate-700 dark:text-slate-300">${file.name}</span>
                            <span class="text-xs text-slate-500">(${HROpsToolkit.formatFileSize(file.size)})</span>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        selectedFilesContainer.classList.remove('hidden');
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        displaySelectedFiles();
        updateProcessButton();
    }

    function updateProcessButton() {
        processBtn.disabled = selectedFiles.length === 0;
        if (selectedFiles.length > 0) {
            processBtn.innerHTML = `<i class="fas fa-magic mr-2"></i>Process ${selectedFiles.length} Image${selectedFiles.length > 1 ? 's' : ''}`;
        } else {
            processBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Process Images';
        }
    }

    // Size presets
    document.querySelectorAll('.size-preset').forEach(button => {
        button.addEventListener('click', () => {
            document.getElementById('output-width').value = button.dataset.width;
            document.getElementById('output-height').value = button.dataset.height;
        });
    });

    // Process images
    processBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('images', file);
        });

        formData.append('width', document.getElementById('output-width').value);
        formData.append('height', document.getElementById('output-height').value);
        formData.append('detect_face', document.getElementById('detect-face').checked);

        // Show processing status
        processingStatus.classList.remove('hidden');
        progressFill.style.width = '0%';
        progressText.textContent = 'Processing...';

        try {
            processBtn.disabled = true;
            processBtn.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>Processing...';

            const response = await fetch('/id-processor/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                progressFill.style.width = '100%';
                progressText.textContent = `${result.processed_count}/${result.total_uploaded} images processed`;

                if (result.errors.length > 0) {
                    HROpsToolkit.showNotification(`Processed ${result.processed_count} images with ${result.errors.length} errors`, 'warning');
                } else {
                    HROpsToolkit.showNotification(`Successfully processed ${result.processed_count} images!`, 'success');
                }

                displayProcessedImages(result.images);
                processedImagesContainer.classList.remove('hidden');

                // Track processing event
                HROpsToolkit.trackEvent('id_images_processed', {
                    count: result.processed_count,
                    face_detection: document.getElementById('detect-face').checked
                });

            } else {
                throw new Error(result.error || 'Processing failed');
            }
        } catch (error) {
            HROpsToolkit.showNotification('Processing failed: ' + error.message, 'error');
        } finally {
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>Process Images';
        }
    });

    function displayProcessedImages(images) {
        processedImages.innerHTML = images.map((image, index) => `
            <div class="id-preview-card">
                <img src="/id-processor/preview/${index}" alt="Processed ${index + 1}" class="id-preview-image">
                <p class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate">${image.original_name}</p>
                <p class="text-xs text-slate-500 dark:text-slate-400">
                    ${image.dimensions[0]}x${image.dimensions[1]} • ${HROpsToolkit.formatFileSize(image.file_size)}
                    ${image.face_detected ? ' • <i class="fas fa-check text-green-500"></i> Face detected' : ''}
                </p>
                <div class="mt-3 flex gap-2">
                    <button onclick="downloadImage(${index})" class="flex-1 px-2 py-1 bg-orange-500 text-white text-sm rounded hover:bg-orange-600">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="previewImage('/id-processor/preview/${index}')" class="px-2 py-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm rounded hover:bg-slate-300 dark:hover:bg-slate-600">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Download functions
    async function downloadImage(index) {
        try {
            window.open(`/id-processor/download/${index}`, '_blank');
        } catch (error) {
            HROpsToolkit.showNotification('Download failed', 'error');
        }
    }

    // Download all images
    document.getElementById('download-all-btn').addEventListener('click', async () => {
        try {
            window.open('/id-processor/download-all', '_blank');
        } catch (error) {
            HROpsToolkit.showNotification('Download failed', 'error');
        }
    });

    // Clear processed images
    document.getElementById('clear-btn').addEventListener('click', async () => {
        try {
            const response = await fetch('/id-processor/clear');
            const result = await response.json();

            if (result.success) {
                processedImagesContainer.classList.add('hidden');
                processedImages.innerHTML = '';
                HROpsToolkit.showNotification('Images cleared', 'info');
            }
        } catch (error) {
            HROpsToolkit.showNotification('Failed to clear images', 'error');
        }
    });

    // Preview image in modal
    function previewImage(src) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4';
        modal.onclick = () => modal.remove();

        modal.innerHTML = `
            <div class="max-w-2xl max-h-full">
                <img src="${src}" alt="Preview" class="max-w-full max-h-full rounded-lg">
                <button class="mt-4 px-4 py-2 bg-white text-black rounded hover:bg-gray-200">
                    Close
                </button>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // Initialize
    updateProcessButton();
});
</script>
{% endblock %}